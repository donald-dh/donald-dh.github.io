---
layout: post
title: "Kafka Operation 3 - Rebalance"
tags: [kafka, operation, series-kafka-operation, rebalance, partition, consumer-group, consumer]
comments: true
---

## 들어가며
카프카를 운영하다보면 여러 상황을 맞이하게 됩니다. 특히 성능 향상을 위해 특정 토픽의 파티션 수를 증가하거나 혹은 컨슈머 그룹에 컨슈머를 추가하는 경우가 있습니다. 하지만 운영 중인 카프카에 위와 같은 작업을 아무런 인정사정 없이(?) 실시하면 서비스 장애 등 예상치 못한 상황을 맞이할 수 있습니다. 이와 관련된 것이 **리밸런싱(Rebalance, Rebalancing)**입니다. 

본 글에서는 리밸런싱에 대해 알아보고, 어떤 상황에서 발생하는 지 알아봅니다. 그리고 나아가 관련한 유의점에 대해 설명합니다. 

## 1. 리밸런싱이란?

 컨슈머 그룹 내의 컨슈머들은 자신들이 읽는 **파티션의 소유권을 공유**합니다. 즉, 하나의 컨슈머 그룹에서 컨슈머 A가 담당하던 파티션 읽기 작업을 컨슈머 B가 이관 받아 작업을 처리할 수 있습니다. 이와 같은 컨슈머 그룹 내의 소유권 이관 작업을 **리밸런싱(Rebalance, Rebalancing)**라고 합니다. 이처럼 리밸런싱은 컨슈머의 파티션 소유권을 조정할 수 있기 때문에 **컨슈머 그룹의 확장성과 가용성을 높여줍니다.** 

## 2. 리밸런싱 발생

 컨슈머의 파티션 소유권이 이관되는 경우는 대표적으로 2가지 상황에서 자동적으로 발생합니다.

1. **컨슈머 그룹의 멤버십 변화 :**
컨슈머 그룹 내의 컨슈머가 제외되거나 추가됐을 경우
2. **새로운 파티션의 추가 :** 
컨슈머 그룹이 구독하고 있는 토픽의 파티션이 추가된 경우

### 2.1. 컨슈머 그룹의 멤버십 변화

 **그룹 코디네이터(GroupCoordinator)**는 `GroupCoordinator` 인스턴스를 백그라운드 프로세스로 실행하는 컨슈머 그룹을 관리하기 위한 브로커입니다. 1번의 상황에서의 리밸런싱은 컨슈머와 그룹 코디네이터 간의 메세지 전달을 통해 발생합니다. 

 컨슈머 그룹의 컨슈머는 폴링(polling)하거나 커밋(commit)할 때 **하트비트(Heartbeat)** 메세지를 그룹 코디네이터에게 전달합니다. 그룹 코디네이터는 하트비트를 성공적으로 전달한 컨슈머를 정상 작동 중이라 판단합니다. 하지만 **그룹 코디네이터가 일정 기간(`session.timeout.ms`)동안 컨슈머의 하트비트를 받지 못하면, 해당 컨슈머는 어떠한 이유(장애, 종료 등)로 작업이 불가한 것으로 판단**하고 해당 컨슈머의 파티션 소유권을 다른 컨슈머로 이관합니다. 즉, 리밸런싱을 실시합니다. 

 반대로 컨슈머 그룹에 컨슈머가 추가된 경우도 리밸런싱이 발생합니다. 추가된 컨슈머는 그룹 코디네이터에 `joinGroup` 메세지를 전송하고, 메세지를 전달받은 그룹 코디네이터는 해당 컨슈머을 포함하여 컨슈머 그룹 내의 파티션 소유권을 재분배합니다.

### 2.2. 새로운 파티션의 추가

특정 토픽의 파티션이 증가하면 해당 파티션에 대한 소유권을 재조정해야 합니다. 그렇기 때문에 리밸런싱을 통해 컨슈머 그룹 내의 컨슈머가 추가된 파티션을 구독할 수 있도록 합니다. 실제 내부 동작은 추후에 추가하겠습니다.

## 3. 리밸런싱의 위험

 리밸런싱은 컨슈머의 소유권을 재조정하는 일입니다. 그렇기 때문에 **리밸런싱이 발생한 컨슈머 그룹 내의 모든 컨슈머의 읽기 작업은 중단됩니다.** 그래서 **컨슈머 측의 일시적인 서비스 중단이 발생할 수 있습니다.** 

 앞서 언급된 것처럼 리밸런싱은 컨슈머의 멤버십의 변화는 물론 파티션 수가 증가할 때도 발생합니다. 리밸런싱은 컨슈머 쪽의 서비스 상태에 일시적인 영향을 줄 수 있으므로 **컨슈머, 파티션의 추가가 필요하다면 충분한 고려 후에 추가하는 것을 추천합니다.** 

 추가로 하트비트 전송 주기를 결정하는 `heartbeat.interval.ms` 설정과 앞서 언급한 `session.timeout.ms`설정(기본값 3초)은 원치않는 리밸런싱 발생에 영향을 미치므로 적절하게 설정할 필요가 있습니다. 대체로 `heartbeat.interval.ms` : `session.timeout.ms` = 1 : 3 으로 설정하는 것은 권장합니다.

## 마무리

 본 글은 통해 리밸런싱에 대해 알아봤습니다. 리밸런싱은 컨슈머의 가용성과 확장성을 제공하는 중요한 역할을 담당하는 작업입니다. 하지만 중요한 만큼 그 영향력이 상당히 큽니다. 그렇기 때문에 운영에 있어서 리밸런싱은 반드시 알아야 하는 작업입니다. 

### 참고

---

[Kafka Rebalance Protocol for the Cloud: Static Membership](https://www.confluent.io/blog/kafka-rebalance-protocol-static-membership/)

[What happens when a new consumer joins the group in Kafka?](https://chrzaszcz.dev/2019/06/kafka-rebalancing/)